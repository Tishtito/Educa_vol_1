<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Marks</title>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
    <link rel="stylesheet" href="../css/Tpanel.css">
    <link rel="stylesheet" href="../css/subject.css">
    <link rel="stylesheet" href="../css/markspopup.css">
</head>
<body>

<div id="headerContainer"></div>
<div id="sidebarContainer"></div>

<section class="marks-table">
    <a href="home.html" class="back-btn">‚Üê Back to Home</a>
    
    <h1 class="heading">Subject Marks Management</h1>

    <!-- Messages -->
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <!-- Marks Out Of -->
    <div class="marks-out-of">
        <label for="marksOutOf">Marks Out Of:</label>
        <input type="number" id="marksOutOf" min="1" max="100" placeholder="e.g., 100">
        <button type="button" id="setMarksBtn">Set</button>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading students...</p>
    </div>

    <!-- Students Table -->
    <div id="studentsContainer" style="display: none;">
        <table class="content-table" id="studentsTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Marks</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Edit Marks Modal -->
    <div class="modal fade" id="editMarksModal" tabindex="-1" aria-labelledby="editMarksLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMarksLabel">Edit Student Marks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editMarksForm">
                    <div class="modal-body">
                        <input type="hidden" id="modalStudentId">
                        <input type="hidden" id="modalStudentClassId">
                        <div class="mb-3">
                            <label for="modalStudentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="modalStudentName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="modalMarksInput" class="form-label">Marks (Out of <span id="modalMarksOutOf">100</span>)</label>
                            <input type="number" class="form-control" id="modalMarksInput" min="0" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Marks</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- No Data Message -->
    <div class="no-data" id="noDataMessage" style="display: none;">
        <i class="fas fa-inbox" style="font-size: 48px; color: #ccc; margin-bottom: 20px; display: block;"></i>
        <p>No students found for this subject and class.</p>
    </div>
</section>

<div id="footerContainer"></div>

<script src="../js/script.js"></script>
<script src="../js/examiner-data.js"></script>
<script src="../js/header-init.js"></script>
<script>
// ========================================
// TOKEN MANAGEMENT
// ========================================
function getSubjectTokenData(token) {
    const tokenMap = JSON.parse(sessionStorage.getItem('subjectTokenMap') || '{}');
    const data = tokenMap[token];
    
    if (!data) {
        console.error('Invalid token: ' + token);
        return null;
    }
    
    return data;
}

// ========================================
// COMPONENT LOADING
// ========================================
async function loadComponentPromise(componentName, containerId) {
    try {
        const res = await fetch(`components/${componentName}.html`);
        if (!res.ok) throw new Error(`Failed to load ${componentName}`);
        const html = await res.text();
        document.getElementById(containerId).innerHTML = html;
        if (containerId === 'headerContainer') {
            document.dispatchEvent(new Event('headerLoaded'));
        }
    } catch (err) {
        console.error(`Error loading ${componentName} component:`, err);
    }
}

// ========================================
// API CONFIGURATION
// ========================================
const API_BASE_URL = '../backend/public/index.php';

// ========================================
// STATE
// ========================================
let subjectId = null;
let classId = null;
let currentSubjectName = null;
let currentClassName = null;
let currentExamId = null;

// ========================================
// DOM ELEMENTS
// ========================================
const loading = document.getElementById('loading');
const studentsContainer = document.getElementById('studentsContainer');
const noDataMessage = document.getElementById('noDataMessage');
const errorMessage = document.getElementById('errorMessage');
const successMessage = document.getElementById('successMessage');
const studentTableBody = document.getElementById('studentTableBody');
const marksOutOfInput = document.getElementById('marksOutOf');
const setMarksBtn = document.getElementById('setMarksBtn');

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
        loadComponentPromise('header', 'headerContainer'),
        loadComponentPromise('sidebar', 'sidebarContainer'),
        loadComponentPromise('footer', 'footerContainer'),
        loadExaminerData()
    ]);

    await checkAuth();
    
    // Load marksOutOf from localStorage if it exists
    const savedMarksOutOf = localStorage.getItem('marksOutOf');
    if (savedMarksOutOf) {
        marksOutOfInput.value = savedMarksOutOf;
    }
    
    // Get token from URL, or fall back to direct IDs for backward compatibility
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    let directSubjectId = params.get('subject_id');
    let directClassId = params.get('class_id');

    if (token) {
        // Retrieve actual IDs from token
        const tokenData = getSubjectTokenData(token);
        if (!tokenData) {
            showError('Invalid or expired link. Please go back and select again.');
            return;
        }
        subjectId = tokenData.subject_id;
        classId = tokenData.class_id;
    } else {
        subjectId = directSubjectId;
        classId = directClassId;
    }

    if (!subjectId || !classId) {
        showError('Missing subject or class ID. Please go back and select again.');
        return;
    }

    await loadStudents(subjectId, classId);
});

// ========================================
// AUTHENTICATION
// ========================================
async function checkAuth() {
    try {
        const response = await fetch(`${API_BASE_URL}/auth/check`, { credentials: 'include' });
        const data = await response.json();

        if (data.success) {
            document.querySelector('.name') && (document.querySelector('.name').textContent = data.name || 'User');
        } else {
            window.location.href = '../index.php';
        }
    } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '../index.php';
    }
}

// ========================================
// LOAD STUDENTS
// ========================================
async function loadStudents(subjectId, classId) {
    try {
        showLoading(true);
        hideMessages();

        const url = `${API_BASE_URL}/subjects/students?subject_id=${subjectId}&class_id=${classId}`;

        const response = await fetch(url, { credentials: 'include' });

        const data = await response.json();

        if (!response.ok) {
            showError(data.message || 'Failed to load students.');
            return;
        }

        if (data.success && data.students && data.students.length > 0) {
            displayStudents(data);
            studentsContainer.style.display = 'block';
            noDataMessage.style.display = 'none';
        } else {
            noDataMessage.style.display = 'block';
            studentsContainer.style.display = 'none';
            showError('No students found for this subject and class.');
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showError('Failed to load students: ' + error.message);
        noDataMessage.style.display = 'block';
        studentsContainer.style.display = 'none';
    } finally {
        showLoading(false);
    }
}

// ========================================
// DISPLAY STUDENTS
// ========================================
function displayStudents(data) {
    studentTableBody.innerHTML = '';

    // Update heading with subject name
    const heading = document.querySelector('.heading');
    if (heading && data.subject_name) {
        heading.textContent = `Subject Marks Management - ${data.subject_name}`;
    }

    data.students.forEach(student => {
        const row = document.createElement('tr');
        const marks = student.marks ?? '-';

        row.innerHTML = `
            <td>${student.name}</td>
            <td id="marks-${student.student_id}">${marks}</td>
            <td>
                <button class="action-btn" onclick="openEditModal(${student.student_id}, ${student.student_class_id}, '${student.name}', ${marks === '-' ? 0 : marks})">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </td>
        `;

        studentTableBody.appendChild(row);
    });
}

// ========================================
// MODAL MANAGEMENT
// ========================================
const editMarksModal = new bootstrap.Modal(document.getElementById('editMarksModal'));
const editMarksForm = document.getElementById('editMarksForm');

function openEditModal(studentId, studentClassId, studentName, currentMarks) {
    // Check if marks out of is set
    const marksOutOf = marksOutOfInput.value;
    if (!marksOutOf) {
        swal({
            title: 'Warning!',
            text: 'Please set the "Marks Out Of" value first.',
            icon: 'warning',
            button: 'OK'
        });
        return;
    }
    
    document.getElementById('modalStudentId').value = studentId;
    document.getElementById('modalStudentClassId').value = studentClassId;
    document.getElementById('modalStudentName').value = studentName;
    document.getElementById('modalMarksInput').value = currentMarks === 0 ? '' : currentMarks;
    document.getElementById('modalMarksOutOf').textContent = marksOutOf;
    editMarksModal.show();
}

editMarksForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = parseInt(document.getElementById('modalStudentId').value);
    const studentClassId = parseInt(document.getElementById('modalStudentClassId').value);
    const marks = parseInt(document.getElementById('modalMarksInput').value);

    if (isNaN(marks) || marks < 0) {
        swal({
            title: 'Error!',
            text: 'Please enter a valid mark.',
            icon: 'error',
            button: 'OK'
        });
        return;
    }

    const marksOutOf = marksOutOfInput.value || 100;
    if (marks > marksOutOf) {
        swal({
            title: 'Error!',
            text: `Marks cannot exceed ${marksOutOf}.`,
            icon: 'error',
            button: 'OK'
        });
        return;
    }

    await updateMarks(studentId, studentClassId, subjectId, marks);
    editMarksModal.hide();
});

// ========================================
// UPDATE MARKS
// ========================================
async function updateMarks(studentId, studentClassId, subjectId, marks) {
    try {
        const marksOutOf = marksOutOfInput.value || 100;
        
        const response = await fetch(`${API_BASE_URL}/subjects/students/marks`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                student_class_id: studentClassId,
                subject_id: parseInt(subjectId),
                marks: marks,
                marks_out_of: parseInt(marksOutOf)
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update display with percentage
            const percentage = ((marks / marksOutOf) * 100);
            document.getElementById(`marks-${studentId}`).textContent = percentage + '%';

            // Show success message
            swal({
                title: 'Success!',
                text: 'Marks updated successfully (' + marks + '/' + marksOutOf + ' = ' + percentage + '%)',
                icon: 'success',
                button: 'OK'
            });
        } else {
            swal({
                title: 'Error!',
                text: data.message || 'Failed to update marks.',
                icon: 'error',
                button: 'OK'
            });
        }
    } catch (error) {
        console.error('Error updating marks:', error);
        swal({
            title: 'Error!',
            text: 'Failed to update marks: ' + error.message,
            icon: 'error',
            button: 'OK'
        });
    }
}

// ========================================
// SET MARKS OUT OF
// ========================================
setMarksBtn.addEventListener('click', () => {
    const marksOutOf = marksOutOfInput.value;

    if (!marksOutOf) {
        swal({
            title: 'Error!',
            text: 'Please enter marks out of value.',
            icon: 'error',
            button: 'OK'
        });
        return;
    }

    // Store in localStorage for reference
    localStorage.setItem('marksOutOf', marksOutOf);
    swal({
        title: 'Success!',
        text: `Marks out of set to ${marksOutOf}`,
        icon: 'success',
        button: 'OK'
    });
    // Keep the value in the input field
});

// ========================================
// UI UTILITIES
// ========================================
function showLoading(show) {
    loading.classList.toggle('active', show);
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
    setTimeout(() => errorMessage.classList.remove('show'), 5000);
}

function showSuccess(message) {
    successMessage.textContent = message;
    successMessage.classList.add('show');
    setTimeout(() => successMessage.classList.remove('show'), 3000);
}

function hideMessages() {
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
}


</script>